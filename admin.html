<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω To√†n di·ªán - Qu√°n Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 15px; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 6px solid #dc3545; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .admin-section { background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .badge-qty { background: #ffc107; color: #000; font-weight: bold; margin-left: 5px; padding: 4px 8px; border-radius: 6px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h2 class="text-center fw-bold text-danger mb-4">üîî QU·∫¢N L√ù QU√ÅN CHUNG</h2>

        <div class="admin-section border-top border-primary border-5">
            <h5 class="fw-bold text-primary">‚ûï TH√äM M√ìN V√ÄO TH·ª∞C ƒê∆†N</h5>
            <div class="row g-2 mt-2">
                <div class="col-6"><input type="text" id="new-item-name" class="form-control" placeholder="T√™n m√≥n (Vd: B√∫n b√≤)"></div>
                <div class="col-4"><input type="number" id="new-item-price" class="form-control" placeholder="Gi√° ti·ªÅn"></div>
                <div class="col-2"><button class="btn btn-primary w-100" onclick="themMon()">L∆ØU</button></div>
            </div>
            <div id="menu-manager-list" class="mt-3 d-flex flex-wrap gap-2"></div>
        </div>

        <div class="row">
            <div class="col-md-6"><div class="bg-danger text-white p-2 mb-2 rounded text-center fw-bold">‚ô®Ô∏è ƒêANG ƒê·ª¢I M√ìN</div><div id="list-chua-lam"></div></div>
            <div class="col-md-6"><div class="bg-success text-white p-2 mb-2 rounded text-center fw-bold">‚úÖ ƒê√É XONG</div><div id="list-da-xong"></div></div>
        </div>

        <div class="admin-section border-top border-warning border-5 mt-4">
            <h4 class="text-center fw-bold text-primary mb-3">üìä B√ÅO C√ÅO H√îM NAY</h4>
            <table class="table table-bordered text-center align-middle">
                <thead class="table-light"><tr><th>M√ìN</th><th>SL</th><th>TI·ªÄN</th></tr></thead>
                <tbody id="item-revenue-list"></tbody>
            </table>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="fw-bold text-success mb-0">T·ªîNG: <span id="total-revenue">0ƒë</span></h4>
                <button class="btn btn-danger fw-bold p-3" onclick="chotSoTongHop()" id="btn-chot-so">üöÄ CH·ªêT S·ªî & G·ª¨I GOOGLE SHEETS</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, increment, limit, addDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzejJUM9aKMmJHdPR3vhpdAI-XwTAhFCPQlKDxkaBzAeHmLQIxfXMbz0TsBWzlVynJPcA/exec";

        // 1. QU·∫¢N L√ù TH·ª∞C ƒê∆†N
        window.themMon = async () => {
            const name = document.getElementById('new-item-name').value;
            const price = parseInt(document.getElementById('new-item-price').value);
            if(!name || !price) return alert("Nh·∫≠p ƒë·ªß t√™n v√† gi√°!");
            await addDoc(collection(db, "MENU"), { name, price });
            document.getElementById('new-item-name').value = "";
            document.getElementById('new-item-price').value = "";
        };

        onSnapshot(collection(db, "MENU"), (snap) => {
            const list = document.getElementById('menu-manager-list');
            list.innerHTML = "";
            snap.forEach(d => {
                list.innerHTML += `<span class="badge bg-light text-dark border p-2">${d.data().name} - ${d.data().price.toLocaleString()}ƒë 
                <b class="text-danger ms-2" style="cursor:pointer" onclick="xoaMon('${d.id}')">√ó</b></span>`;
            });
        });

        window.xoaMon = async (id) => { if(confirm("X√≥a m√≥n n√†y?")) await deleteDoc(doc(db, "MENU", id)); };

        // 2. HI·ªÇN TH·ªä ƒê∆†N H√ÄNG (GI·ªÆ NGUY√äN LOGIC C≈®)
        onSnapshot(query(collection(db, "orders"), orderBy("thoiGian", "desc")), (snapshot) => {
            const listChuaLam = document.getElementById('list-chua-lam');
            const listDaXong = document.getElementById('list-da-xong');
            listChuaLam.innerHTML = ""; listDaXong.innerHTML = "";
            snapshot.forEach((orderDoc) => {
                const d = orderDoc.data();
                const itemsHtml = d.danhSachMon.map(i => `<div>‚Ä¢ ${i.name} <span class="badge-qty">x${i.qty}</span></div>`).join('');
                const card = `<div class="order-card">
                    <div class="fw-bold text-danger fs-5">üë§ KH√ÅCH: ${d.khach}</div>
                    <div class="my-2">${itemsHtml}</div>
                    <div class="fw-bold pt-2 border-top">T·ªïng: ${Number(d.tongTien).toLocaleString()}ƒë</div>
                    ${d.trangThai === "da_xong" 
                        ? `<button class="btn btn-success w-100 mt-2 fw-bold" onclick="thanhToanDon('${orderDoc.id}', ${JSON.stringify(d).replace(/"/g, '&quot;')})">THANH TO√ÅN</button>`
                        : `<button class="btn btn-primary w-100 mt-2 fw-bold" onclick="hoanThanhMon('${orderDoc.id}')">XONG ‚ûî</button>`}
                </div>`;
                d.trangThai === "da_xong" ? listDaXong.innerHTML += card : listChuaLam.innerHTML += card;
            });
        });

        // (C√°c h√†m thanhToanDon, hoanThanhMon, chotSoTongHop gi·ªØ nguy√™n nh∆∞ b·∫£n tr∆∞·ªõc)
        window.hoanThanhMon = async (id) => { await updateDoc(doc(db, "orders", id), { trangThai: "da_xong" }); };
        window.thanhToanDon = async (id, data) => {
            const reportRef = doc(db, "REPORTS", today);
            let updates = { all_total: increment(data.tongTien) };
            data.danhSachMon.forEach(m => {
                updates[`${m.name}.amount`] = increment(m.price * m.qty);
                updates[`${m.name}.qty`] = increment(m.qty);
            });
            await setDoc(reportRef, updates, { merge: true });
            await deleteDoc(doc(db, "orders", id));
        };
        window.chotSoTongHop = async () => {
            const docSnap = await getDoc(doc(db, "REPORTS", today));
            if (!docSnap.exists()) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            const data = docSnap.data();
            const itemsToSave = Object.keys(data).filter(k => k !== 'all_total').map(key => {
                let cleanName = key.replace(".amount", "").replace(".qty", "");
                return { tenMon: cleanName, soLuong: data[key].qty || 0, tongTien: data[key].amount || 0 };
            }).filter(i => i.soLuong > 0);
            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ ngay: today, details: itemsToSave }) });
                await setDoc(doc(db, "HISTORY", today), { date_id: today, total: data.all_total, items: itemsToSave, timestamp: new Date() });
                await deleteDoc(doc(db, "REPORTS", today));
                alert("‚úÖ CH·ªêT S·ªî TH√ÄNH C√îNG!");
            } catch (e) { alert("L·ªói!"); }
        };
    </script>
</body>
</html>
