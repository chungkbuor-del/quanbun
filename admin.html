<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qu·∫£n l√Ω Qu√°n Chung - S·ª≠a l·ªói Th·ªëng k√™</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 15px; font-family: sans-serif; }
        .admin-title { color: #dc3545; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-left: 5px solid #0d6efd; }
        .report-card { background: white; border-radius: 12px; padding: 20px; border-top: 5px solid #ffc107; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 20px; }
        .history-card { background: #fff; border-radius: 12px; padding: 20px; border-top: 5px solid #6c757d; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h2 class="admin-title">üîî QU·∫¢N L√ù QU√ÅN CHUNG</h2>
        <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

        <div class="row">
            <div class="col-md-6"><div class="bg-danger text-white p-2 mb-2 rounded text-center fw-bold">‚ô®Ô∏è ƒê∆†N CH∆ØA L√ÄM</div><div id="list-chua-lam"></div></div>
            <div class="col-md-6"><div class="bg-success text-white p-2 mb-2 rounded text-center fw-bold">‚úÖ ƒê∆†N ƒê√É XONG</div><div id="list-da-xong"></div></div>
        </div>

        <div class="report-card">
            <h4 class="text-center fw-bold mb-3 text-primary">üìä DOANH THU H√îM NAY (<span id="current-date">--/--</span>)</h4>
            <div class="table-responsive">
                <table class="table table-bordered text-center align-middle">
                    <thead class="table-light"><tr><th>M√ìN</th><th>SL</th><th>TH√ÄNH TI·ªÄN</th></tr></thead>
                    <tbody id="item-revenue-list"></tbody>
                </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="fw-bold text-success mb-0">T·ªîNG: <span id="total-revenue">0ƒë</span></h4>
                <button class="btn btn-primary fw-bold p-3" onclick="chotSoTaiCho()" id="btn-chot-so">üîí CH·ªêT S·ªî & L∆ØU L·ªäCH S·ª¨</button>
            </div>
        </div>

        <div class="history-card">
            <h4 class="fw-bold mb-4 text-secondary">üìú L·ªäCH S·ª¨ DOANH THU</h4>
            <div id="history-list"></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
        document.getElementById('current-date').innerText = today;

        // H√†m x·ª≠ l√Ω gom nh√≥m d·ªØ li·ªáu b·ªã l·ªói t√™n m√≥n (.amount, .qty)
        function processReportData(data) {
            let itemsMap = {};
            Object.keys(data).forEach(key => {
                if (key === 'all_total') return;
                
                // T√°ch t√™n m√≥n s·∫°ch (v√≠ d·ª• "B√öN C√Å.qty" -> "B√öN C√Å")
                let cleanName = key.replace(".amount", "").replace(".qty", "");
                
                if (!itemsMap[cleanName]) itemsMap[cleanName] = { name: cleanName, qty: 0, amount: 0 };
                
                // C·ªông d·ªìn v√†o t√™n m√≥n t∆∞∆°ng ·ª©ng
                if (key.includes(".qty")) itemsMap[cleanName].qty += data[key];
                else if (key.includes(".amount")) itemsMap[cleanName].amount += data[key];
                else if (typeof data[key] === 'object') { // H·ªó tr·ª£ c·∫£ c·∫•u tr√∫c c≈© n·∫øu c√≥
                    itemsMap[cleanName].qty += data[key].qty || 0;
                    itemsMap[cleanName].amount += data[key].amount || 0;
                }
            });
            return Object.values(itemsMap).filter(i => i.qty > 0);
        }

        onSnapshot(query(collection(db, "orders"), orderBy("thoiGian", "desc")), (snapshot) => {
            const listChuaLam = document.getElementById('list-chua-lam');
            const listDaXong = document.getElementById('list-da-xong');
            listChuaLam.innerHTML = ""; listDaXong.innerHTML = "";
            snapshot.forEach((orderDoc) => {
                const data = orderDoc.data();
                const card = `<div class="order-card p-3">
                    <div class="fw-bold text-danger fs-5">B√ÄN: ${data.ban}</div>
                    <div class="text-muted my-2">${data.danhSachMon.map(m => `<div>‚Ä¢ ${m.name}</div>`).join('')}</div>
                    <div class="fw-bold text-dark border-top pt-2">T·ªïng: ${Number(data.tongTien).toLocaleString()}ƒë</div>
                    ${data.trangThai === "da_xong" 
                        ? `<button class="btn btn-success w-100 mt-2 fw-bold" onclick="thanhToanDon('${orderDoc.id}', ${JSON.stringify(data).replace(/"/g, '&quot;')})">THANH TO√ÅN</button>`
                        : `<button class="btn btn-primary w-100 mt-2 fw-bold" onclick="hoanThanhMon('${orderDoc.id}')">XONG ‚ûî</button>`}
                </div>`;
                data.trangThai === "da_xong" ? listDaXong.innerHTML += card : listChuaLam.innerHTML += card;
            });
        });

        onSnapshot(doc(db, "REPORTS", today), (docSnap) => {
            const list = document.getElementById('item-revenue-list');
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('total-revenue').innerText = Number(data.all_total || 0).toLocaleString() + "ƒë";
                const processedItems = processReportData(data);
                list.innerHTML = processedItems.map(i => `<tr><td class="text-start ps-3 fw-bold">${i.name}</td><td>${i.qty}</td><td class="text-end pe-3">${i.amount.toLocaleString()}</td></tr>`).join('');
            } else {
                document.getElementById('total-revenue').innerText = "0ƒë";
                list.innerHTML = "<tr><td colspan='3' class='text-muted'>Ch∆∞a c√≥ d·ªØ li·ªáu</td></tr>";
            }
        });

        onSnapshot(query(collection(db, "HISTORY"), orderBy("timestamp", "desc"), limit(10)), (snapshot) => {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = "";
            snapshot.forEach(docSnap => {
                const h = docSnap.data();
                let rows = h.items.map(i => `<tr><td class="text-start ps-2">${i.tenMon}</td><td>${i.soLuong}</td><td class="text-end pe-2">${Number(i.tongTien).toLocaleString()}</td></tr>`).join('');
                historyList.innerHTML += `<div class="history-item mb-4 border rounded p-3 bg-white">
                    <div class="fw-bold text-primary mb-2">üìÖ Ng√†y: ${h.date_id}</div>
                    <table class="table table-sm table-bordered text-center">
                        <thead class="table-secondary"><tr><th>M√ìN</th><th>SL</th><th>TI·ªÄN</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>
                    <div class="text-end fw-bold text-success mt-1">T·ªîNG DOANH THU: ${Number(h.total).toLocaleString()}ƒë</div>
                </div>`;
            });
        });

        window.hoanThanhMon = async (id) => { await updateDoc(doc(db, "orders", id), { trangThai: "da_xong" }); };

        window.thanhToanDon = async (id, data) => {
            if(!confirm(`Thanh to√°n B√†n ${data.ban}?`)) return;
            const reportRef = doc(db, "REPORTS", today);
            let updates = { all_total: increment(data.tongTien) };
            data.danhSachMon.forEach(m => {
                updates[`${m.name}.amount`] = increment(m.price);
                updates[`${m.name}.qty`] = increment(1);
            });
            await setDoc(reportRef, updates, { merge: true });
            await deleteDoc(doc(db, "orders", id));
        };

        window.chotSoTaiCho = async () => {
            const docSnap = await getDoc(doc(db, "REPORTS", today));
            if (!docSnap.exists() || !docSnap.data().all_total) return alert("Kh√¥ng c√≥ doanh thu!");
            if (!confirm("Ch·ªët s·ªï v√† b·∫Øt ƒë·∫ßu ng√†y m·ªõi?")) return;
            
            const processedItems = processReportData(docSnap.data());
            const itemsToSave = processedItems.map(i => ({ tenMon: i.name, soLuong: i.qty, tongTien: i.amount }));

            try {
                await setDoc(doc(db, "HISTORY", today), { date_id: today, total: docSnap.data().all_total, items: itemsToSave, timestamp: new Date() });
                await deleteDoc(doc(db, "REPORTS", today));
                alert("‚úÖ CH·ªêT S·ªî TH√ÄNH C√îNG!");
            } catch (e) { alert("L·ªói: " + e.message); }
        };
    </script>
</body>
</html>
