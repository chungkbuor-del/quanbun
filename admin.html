<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Qu√°n Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 15px; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; border-left: 5px solid #0d6efd; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .report-card { background: white; border-radius: 12px; padding: 20px; border-top: 5px solid #ffc107; margin-top: 20px; }
        .history-card { background: #fff; border-radius: 12px; padding: 20px; border-top: 5px solid #6c757d; margin-top: 30px; }
        .badge-qty { background: #ffc107; color: #000; margin-left: 5px; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h2 class="text-center fw-bold text-danger mb-4">üîî QU·∫¢N L√ù QU√ÅN CHUNG</h2>

        <div class="row">
            <div class="col-md-6"><div class="bg-danger text-white p-2 mb-2 rounded text-center fw-bold">‚ô®Ô∏è ƒê∆†N CH∆ØA L√ÄM</div><div id="list-chua-lam"></div></div>
            <div class="col-md-6"><div class="bg-success text-white p-2 mb-2 rounded text-center fw-bold">‚úÖ ƒê√É XONG</div><div id="list-da-xong"></div></div>
        </div>

        <div class="report-card">
            <h4 class="text-center fw-bold text-primary mb-3">üìä DOANH THU H√îM NAY (<span id="current-date">--/--</span>)</h4>
            <table class="table table-bordered text-center align-middle">
                <thead class="table-light"><tr><th>M√ìN</th><th>SL</th><th>TH√ÄNH TI·ªÄN</th></tr></thead>
                <tbody id="item-revenue-list"></tbody>
            </table>
            <div class="d-flex justify-content-between align-items-center mt-3">
                <h4 class="fw-bold text-success mb-0">T·ªîNG: <span id="total-revenue">0ƒë</span></h4>
                <button class="btn btn-primary fw-bold" onclick="chotSoTongHop()" id="btn-chot-so">üöÄ CH·ªêT S·ªî & G·ª¨I SHEETS</button>
            </div>
        </div>

        <div class="history-card"><h4 class="fw-bold text-secondary mb-3">üìú L·ªäCH S·ª¨</h4><div id="history-list"></div></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, increment, limit } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
        document.getElementById('current-date').innerText = today;
        const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzejJUM9aKMmJHdPR3vhpdAI-XwTAhFCPQlKDxkaBzAeHmLQIxfXMbz0TsBWzlVynJPcA/exec";

        // Gom nh√≥m m√≥n l·ªói (.amount/.qty) v√† hi·ªÉn th·ªã x3 x4
        function processData(data) {
            let itemsMap = {};
            Object.keys(data).forEach(key => {
                if (key === 'all_total') return;
                let cleanName = key.replace(".amount", "").replace(".qty", "");
                if (!itemsMap[cleanName]) itemsMap[cleanName] = { name: cleanName, qty: 0, amount: 0 };
                if (key.includes(".qty")) itemsMap[cleanName].qty += data[key];
                else if (key.includes(".amount")) itemsMap[cleanName].amount += data[key];
            });
            return Object.values(itemsMap).filter(i => i.qty > 0);
        }

        onSnapshot(query(collection(db, "orders"), orderBy("thoiGian", "desc")), (snapshot) => {
            const listChuaLam = document.getElementById('list-chua-lam');
            const listDaXong = document.getElementById('list-da-xong');
            listChuaLam.innerHTML = ""; listDaXong.innerHTML = "";
            snapshot.forEach((orderDoc) => {
                const d = orderDoc.data();
                // Gom nh√≥m m√≥n TRONG M·ªòT ƒê∆†N ƒë·ªÉ hi·ªán B√öN C√Å x3
                let itemsMap = {};
                d.danhSachMon.forEach(m => {
                    if (itemsMap[m.name]) itemsMap[m.name].qty += (m.qty || 1);
                    else itemsMap[m.name] = { name: m.name, qty: (m.qty || 1) };
                });
                const itemsHtml = Object.values(itemsMap).map(i => `<div>‚Ä¢ ${i.name} <span class="badge badge-qty">x${i.qty}</span></div>`).join('');
                
                const card = `<div class="order-card">
                    <div class="fw-bold text-danger fs-5">B√ÄN: ${d.ban}</div>
                    <div class="my-2">${itemsHtml}</div>
                    <div class="fw-bold pt-2 border-top">T·ªïng: ${Number(d.tongTien).toLocaleString()}ƒë</div>
                    ${d.trangThai === "da_xong" 
                        ? `<button class="btn btn-success w-100 mt-2" onclick="thanhToanDon('${orderDoc.id}', ${JSON.stringify(d).replace(/"/g, '&quot;')})">THANH TO√ÅN</button>`
                        : `<button class="btn btn-primary w-100 mt-2" onclick="hoanThanhMon('${orderDoc.id}')">XONG ‚ûî</button>`}
                </div>`;
                d.trangThai === "da_xong" ? listDaXong.innerHTML += card : listChuaLam.innerHTML += card;
            });
        });

        onSnapshot(doc(db, "REPORTS", today), (docSnap) => {
            const list = document.getElementById('item-revenue-list');
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('total-revenue').innerText = Number(data.all_total || 0).toLocaleString() + "ƒë";
                const items = processData(data);
                list.innerHTML = items.map(i => `<tr><td class="text-start fw-bold">${i.name}</td><td>${i.qty}</td><td class="text-end">${i.amount.toLocaleString()}</td></tr>`).join('');
            }
        });

        onSnapshot(query(collection(db, "HISTORY"), orderBy("timestamp", "desc"), limit(5)), (snapshot) => {
            const list = document.getElementById('history-list');
            list.innerHTML = "";
            snapshot.forEach(docSnap => {
                const h = docSnap.data();
                let rows = h.items.map(i => `<tr><td>${i.tenMon}</td><td>${i.soLuong}</td><td>${Number(i.tongTien).toLocaleString()}</td></tr>`).join('');
                list.innerHTML += `<div class="p-3 mb-3 border rounded bg-white small">
                    <div class="fw-bold text-primary mb-1">üìÖ ${h.date_id}</div>
                    <table class="table table-sm table-bordered mb-1"><tbody>${rows}</tbody></table>
                    <div class="text-end fw-bold text-success">T·ªîNG: ${Number(h.total).toLocaleString()}ƒë</div>
                </div>`;
            });
        });

        window.hoanThanhMon = async (id) => { await updateDoc(doc(db, "orders", id), { trangThai: "da_xong" }); };

        window.thanhToanDon = async (id, data) => {
            if(!confirm(`Thanh to√°n B√†n ${data.ban}?`)) return;
            const reportRef = doc(db, "REPORTS", today);
            let updates = { all_total: increment(data.tongTien) };
            data.danhSachMon.forEach(m => {
                updates[`${m.name}.amount`] = increment(m.price * (m.qty || 1));
                updates[`${m.name}.qty`] = increment(m.qty || 1);
            });
            await setDoc(reportRef, updates, { merge: true });
            await deleteDoc(doc(db, "orders", id));
        };

        window.chotSoTongHop = async () => {
            const docSnap = await getDoc(doc(db, "REPORTS", today));
            if (!docSnap.exists()) return alert("Kh√¥ng c√≥ d·ªØ li·ªáu!");
            if (!confirm("G·ª≠i Google Sheets v√† Reset d·ªØ li·ªáu?")) return;
            
            const btn = document.getElementById('btn-chot-so');
            btn.disabled = true;
            const data = docSnap.data();
            const cleanItems = processData(data);
            const itemsToSave = cleanItems.map(i => ({ tenMon: i.name, soLuong: i.qty, tongTien: i.amount }));

            try {
                await fetch(WEB_APP_URL, { method: "POST", mode: "no-cors", body: JSON.stringify({ ngay: today, details: itemsToSave }) });
                await setDoc(doc(db, "HISTORY", today), { date_id: today, total: data.all_total, items: itemsToSave, timestamp: new Date() });
                await deleteDoc(doc(db, "REPORTS", today));
                alert("‚úÖ TH√ÄNH C√îNG!");
            } catch (e) { alert("L·ªói!"); } finally { btn.disabled = false; }
        };
    </script>
</body>
</html>
