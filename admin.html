<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Qu·∫£n l√Ω & Doanh thu - Qu√°n Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding: 20px; font-family: sans-serif; }
        .admin-title { color: #dc3545; font-weight: bold; text-align: center; margin-bottom: 20px; }
        .section-title { background: #dc3545; color: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; font-weight: bold; }
        .order-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border: none; }
        .report-card { background: #fff; border-radius: 12px; padding: 20px; border-top: 5px solid #ffc107; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .btn-done { background-color: #007bff; color: white; border: none; border-radius: 8px; font-weight: bold; width: 100%; padding: 8px; margin-top: 10px; }
        .btn-pay { background-color: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; width: 100%; padding: 8px; margin-top: 10px; }
        .item-row-report { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dashed #eee; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="admin-title">üîî QU·∫¢N L√ù QU√ÅN CHUNG</h2>
        <audio id="notif-sound" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3" preload="auto"></audio>

        <div class="row mb-5">
            <div class="col-md-6">
                <div class="section-title text-center">‚ô®Ô∏è CH∆ØA L√ÄM</div>
                <div id="list-chua-lam"></div>
            </div>
            <div class="col-md-6">
                <div class="section-title text-center" style="background: #28a745;">‚úÖ ƒê√É XONG</div>
                <div id="list-da-xong"></div>
            </div>
        </div>

        <hr>

        <div class="report-card mt-4">
            <h3 class="text-center fw-bold mb-4">üìä DOANH THU NG√ÄY <span id="current-date">--/--</span></h3>
            <div class="text-center mb-4">
                <h1 class="text-success fw-bold" id="total-revenue">0ƒë</h1>
            </div>
            <div id="item-revenue-list">
                </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, onSnapshot, updateDoc, deleteDoc, doc, query, orderBy, setDoc, getDoc, increment } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let firstLoad = true;

        // L·∫•y ng√†y hi·ªán t·∫°i ƒë·ªãnh d·∫°ng DD-MM-YYYY
        const today = new Date().toLocaleDateString('vi-VN').replace(/\//g, '-');
        document.getElementById('current-date').innerText = today;

        // 1. L·∫ÆNG NGHE ƒê∆†N H√ÄNG
        onSnapshot(query(collection(db, "orders"), orderBy("thoiGian", "desc")), (snapshot) => {
            const listChuaLam = document.getElementById('list-chua-lam');
            const listDaXong = document.getElementById('list-da-xong');
            listChuaLam.innerHTML = ""; listDaXong.innerHTML = "";

            if (!firstLoad && snapshot.docChanges().some(change => change.type === "added")) {
                document.getElementById('notif-sound').play().catch(() => {});
            }
            firstLoad = false;

            snapshot.forEach((orderDoc) => {
                const data = orderDoc.data();
                const monHtml = data.danhSachMon.map(m => `<div>‚Ä¢ ${m.name}</div>`).join('');
                const card = `<div class="order-card">
                    <div class="fw-bold fs-5 text-danger">B√ÄN: ${data.ban}</div>
                    <div class="small text-muted mb-2">${monHtml}</div>
                    <div class="fw-bold">T·ªïng: ${Number(data.tongTien).toLocaleString()}ƒë</div>
                    ${data.trangThai === "da_xong" 
                        ? `<button class="btn-pay" onclick="payOrder('${orderDoc.id}', ${JSON.stringify(data)})">THANH TO√ÅN</button>`
                        : `<button class="btn-done" onclick="markDone('${orderDoc.id}')">XONG ‚ûî</button>`}
                </div>`;
                data.trangThai === "da_xong" ? listDaXong.innerHTML += card : listChuaLam.innerHTML += card;
            });
        });

        // 2. L·∫ÆNG NGHE DOANH THU NG√ÄY
        onSnapshot(doc(db, "REPORTS", today), (docSnap) => {
            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('total-revenue').innerText = Number(data.all_total || 0).toLocaleString() + "ƒë";
                
                let html = "";
                // S·∫Øp x·∫øp m√≥n theo doanh thu gi·∫£m d·∫ßn
                Object.keys(data).filter(k => k !== 'all_total').forEach(monName => {
                    html += `<div class="item-row-report"><span>${monName}</span><b>${data[monName].toLocaleString()}ƒë</b></div>`;
                });
                document.getElementById('item-revenue-list').innerHTML = html;
            }
        });

        window.markDone = async (id) => { await updateDoc(doc(db, "orders", id), { trangThai: "da_xong" }); };

        window.payOrder = async (id, orderData) => {
            if(!confirm(`Thanh to√°n ${Number(orderData.tongTien).toLocaleString()}ƒë?`)) return;

            const reportRef = doc(db, "REPORTS", today);
            const updates = { all_total: increment(orderData.tongTien) };
            
            // C·ªông d·ªìn ti·ªÅn cho t·ª´ng m√≥n
            orderData.danhSachMon.forEach(mon => {
                updates[mon.name] = increment(mon.price);
            });

            try {
                await setDoc(reportRef, updates, { merge: true });
                await deleteDoc(doc(db, "orders", id));
            } catch (e) { alert("L·ªói l∆∞u doanh thu!"); }
        };

        document.body.addEventListener('click', () => { document.getElementById('notif-sound').muted = false; }, {once: true});
    </script>
</body>
</html>