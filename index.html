<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Quán Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 100px; }
        .item-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #ff4757; color: white; padding: 15px; border-radius: 20px 20px 0 0; display: none; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container mt-3">
        <h3 class="text-center text-danger fw-bold">QUÁN CỦA CHUNG</h3>
        <p class="text-center">Bàn số: <span id="label-ban" class="badge bg-dark">...</span></p>
        <div id="menu-list">Đang tải menu...</div>
    </div>

    <div id="cart-bar" class="cart-bar text-center" onclick="guiDon()">
        <span id="cart-info">0 món - 0đ</span> | <b>GỬI ĐƠN NGAY</b>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = { /* Dán lại mã Config của bạn ở hình 7 vào đây */ };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let gioHang = [];
        const table = new URLSearchParams(window.location.search).get('table') || "Chưa rõ";
        document.getElementById('label-ban').innerText = table;

        async function loadMenu() {
            const querySnapshot = await getDocs(collection(db, "MENU"));
            const container = document.getElementById('menu-list');
            container.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const item = doc.data();
                const div = document.createElement('div');
                div.className = "item-card d-flex justify-content-between align-items-center";
                div.innerHTML = `<div><b>${item.NAME}</b><br><span class="text-danger">${Number(item['THÀNH TIỀN']).toLocaleString()}đ</span></div>
                                 <button class="btn btn-outline-danger btn-sm" onclick="themMon('${item.NAME}', ${item['THÀNH TIỀN']})">+</button>`;
                container.appendChild(div);
            });
        }

        window.themMon = (name, price) => {
            gioHang.push({ name, price });
            updateCart();
        };

        function updateCart() {
            const bar = document.getElementById('cart-bar');
            if (gioHang.length > 0) {
                bar.style.display = 'block';
                const tongTien = gioHang.reduce((sum, item) => sum + item.price, 0);
                document.getElementById('cart-info').innerText = `${gioHang.length} món - ${tongTien.toLocaleString()}đ`;
            }
        }

        window.guiDon = async () => {
            if (confirm("Bạn xác nhận gửi đơn hàng này chứ?")) {
                const tongTien = gioHang.reduce((sum, item) => sum + item.price, 0);
                await addDoc(collection(db, "orders"), {
                    ban: table,
                    danhSachMon: gioHang, // Gửi cả mảng món ăn
                    tongTien: tongTien,
                    thoiGian: serverTimestamp(),
                    trangThai: "Chờ"
                });
                alert("Đã gửi đơn! Vui lòng đợi trong giây lát.");
                gioHang = [];
                document.getElementById('cart-bar').style.display = 'none';
            }
        };
        loadMenu();
    </script>
</body>
</html>