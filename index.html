<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Quán Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; padding-bottom: 100px; }
        .item-card { background: white; border-radius: 15px; padding: 15px; margin-bottom: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .cart-bar { position: fixed; bottom: 20px; left: 10px; right: 10px; background: #ff4757; color: white; padding: 15px; border-radius: 50px; display: none; cursor: pointer; z-index: 1000; }
    </style>
</head>
<body>
    <div class="container mt-3">
        <div class="text-center mb-4">
            <h2 class="text-danger fw-bold">QUÁN CỦA CHUNG</h2>
            <div class="badge bg-dark fs-6">Bàn số: <span id="label-ban">...</span></div>
        </div>
        <div id="menu-list" class="row"></div>
    </div>

    <div id="cart-bar" class="cart-bar text-center" onclick="guiDon()">
        <span id="cart-info">0 món - 0đ</span> | <b class="ms-2">GỬI ĐƠN NGAY</b>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let gioHang = [];

        const urlParams = new URLSearchParams(window.location.search);
        const tableNum = urlParams.get('table') || urlParams.get('TABLE') || "Chưa rõ";
        document.getElementById('label-ban').innerText = tableNum;

        async function loadMenu() {
            try {
                const querySnapshot = await getDocs(collection(db, "MENU"));
                const container = document.getElementById('menu-list');
                container.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const item = doc.data();
                    const div = document.createElement('div');
                    div.className = "col-12 col-md-6";
                    div.innerHTML = `<div class="item-card d-flex justify-content-between align-items-center">
                        <div><b>${item.NAME}</b><br><span class="text-danger">${Number(item['THÀNH TIỀN']).toLocaleString()}đ</span></div>
                        <button class="btn btn-danger btn-sm" onclick="themMon('${item.NAME}', ${item['THÀNH TIỀN']})">+</button>
                    </div>`;
                    container.appendChild(div);
                });
            } catch (e) { console.error(e); }
        }

        window.themMon = (name, price) => {
            gioHang.push({ name, price });
            document.getElementById('cart-bar').style.display = 'block';
            const tongTien = gioHang.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-info').innerText = `${gioHang.length} món - ${tongTien.toLocaleString()}đ`;
        };

        window.guiDon = async () => {
            const btn = document.getElementById('cart-bar');
            btn.style.pointerEvents = 'none';
            btn.innerHTML = "ĐANG GỬI...";
            try {
                await addDoc(collection(db, "orders"), {
                    ban: tableNum,
                    danhSachMon: gioHang,
                    tongTien: gioHang.reduce((sum, item) => sum + item.price, 0),
                    thoiGian: serverTimestamp()
                });
                alert("Đã gửi đơn!");
                location.reload();
            } catch (e) { alert("Lỗi gửi đơn!"); btn.style.pointerEvents = 'auto'; }
        };
        loadMenu();
    </script>
</body>
</html>