<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Menu Quán Chung</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f0f2f5; padding-bottom: 100px; }
        .header-title { color: #dc3545; font-weight: bold; margin-top: 20px; }
        .table-label { background: #6c757d; color: white; border-radius: 5px; padding: 3px 10px; font-size: 0.9rem; }
        .item-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 10px; border: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .price { color: #dc3545; font-weight: bold; }
        .btn-add { background-color: #ff4757; color: white; border: none; border-radius: 8px; padding: 5px 15px; font-weight: bold; }
        .cart-bar { position: fixed; bottom: 0; left: 0; right: 0; background: #ff4757; color: white; padding: 15px; border-radius: 15px 15px 0 0; display: none; cursor: pointer; text-align: center; }
    </style>
</head>
<body>
    <div class="container">
        <h2 class="text-center header-title">QUÁN CỦA CHUNG</h2>
        <div class="text-center mb-3">
            <span class="table-label">Đang ngồi bàn: <span id="label-ban">...</span></span>
        </div>
        <div id="menu-list"></div>
    </div>

    <div id="cart-bar" class="cart-bar" onclick="guiDon()">
        <span id="cart-info">0 món - 0đ</span> | <b>GỬI ĐƠN NGAY</b>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCOasks_plua7yYBVgXIN3dKNIBS3WhO3Y",
            authDomain: "quanbun-6cf3b.firebaseapp.com",
            projectId: "quanbun-6cf3b",
            storageBucket: "quanbun-6cf3b.firebasestorage.app",
            messagingSenderId: "553498423375",
            appId: "1:553498423375:web:8c1ecdc1b3bd14651e7a3a"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        let gioHang = [];

        const urlParams = new URLSearchParams(window.location.search);
        const table = urlParams.get('table') || urlParams.get('TABLE') || "Chưa rõ";
        document.getElementById('label-ban').innerText = table;

        async function loadMenu() {
            const querySnapshot = await getDocs(collection(db, "MENU"));
            const container = document.getElementById('menu-list');
            container.innerHTML = "";
            querySnapshot.forEach((doc) => {
                const item = doc.data();
                const div = document.createElement('div');
                div.className = "item-card d-flex justify-content-between align-items-center";
                div.innerHTML = `<div><b class="fs-5">${item.NAME}</b><br><span class="price">${Number(item['THÀNH TIỀN']).toLocaleString()}đ</span></div>
                                 <button class="btn-add" onclick="themMon('${item.NAME}', ${item['THÀNH TIỀN']})">CHỌN</button>`;
                container.appendChild(div);
            });
        }

        window.themMon = (name, price) => {
            gioHang.push({ name, price });
            document.getElementById('cart-bar').style.display = 'block';
            const tongTien = gioHang.reduce((sum, item) => sum + item.price, 0);
            document.getElementById('cart-info').innerText = `${gioHang.length} món - ${tongTien.toLocaleString()}đ`;
        };

        window.guiDon = async () => {
            if(!confirm("Gửi đơn hàng này tới nhà bếp?")) return;
            await addDoc(collection(db, "orders"), {
                ban: table,
                danhSachMon: gioHang,
                tongTien: gioHang.reduce((sum, item) => sum + item.price, 0),
                thoiGian: serverTimestamp()
            });
            alert("Đã gửi đơn thành công!");
            location.reload();
        };
        loadMenu();
    </script>
</body>
</html>